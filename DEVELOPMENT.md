Installation in development mode
================================


Foreword
--------

This document covers all aspects of setting up of Pyrone development environment on Linux
(Debian 9.3 "Stretch").

We use python venv to install required python packages.

MacOS as development platform is not supported anymore, use Virtualbox/VMWare.


Preparing virtual environment
-----------------------------

First you need to install `python` (version 3.5 or 3.6, version 2 is not supported) and
some other packages.

    $ sudo apt-get install python3 python3-venv python3-dev postgresql-9.6 

Also you'll need to install additional binary packages:

    $ sudo apt-get install dh-exec curl gcc libxml2-dev libxslt1-dev libjpeg62-turbo-dev libfreetype6-dev zlib1g-dev libpq-dev
    
Now we are going to set up development virtual environment in the project directory:

    $ python3 -m venv .venv

You now have the directory with new virtual environment, now you should *activate* it, after 
activation all required commands will be executed from your virtual environment, not from the
system. Required commands are: `python`, `pip`  etc. So activate (remember,
we are in the project directory):

    $ source .venv/bin/activate

Make sure that important commands are resolved correctly, if you are using zsh 
execute command `rehash`:

    $ which pip3
    /home/user/pyrone/.venv/bin/pip3
    $ which python3
    /home/user/pyrone/.venv/bin/python3

And finally install now all required python packages (execute this command in the activated 
environment and from project directory):

    $ python3 setup.py develop

Copy configuration script `development.ini` from the directory `examples` to the same directory 
where `setup.py` is located, edit `development.ini` appropriately, but default preferences are 
just fine. By default pyrone development config uses sqlite database
engine.

Now setup database: create database and user, use default password `pbpass`:

    # sudo -u postgres createdb pyrone_blog
    # sudo -u postgres createuser pyrone_blog_user -P


Working with development server
-------------------------------

To start development server use the following command:

    $ pserve --reload development.ini

On first run or after database destroy you need to initialize database:

    $ pyronedbinit development.ini --sample-data


Localization and internationalization
-------------------------------------

Pyrone uses `Babel` package to maintain `gettext`-translation file. Here are the most used
commands.

Collect messages from source files (python only):

    $ python3 setup.py extract_messages extract_messages_js

Update messages (using .pot-file created by `extract_messages` command):

    $ python3 setup.py update_catalog update_catalog_js

Or collect and update in one step:

    $ python3 setup.py extract_messages update_catalog extract_messages_js update_catalog_js

Compile translation files (for python code):

    $ python3 setup.py compile_catalog compile_catalog_js

Start new language ("es", Spanish in this example, both for python and javascript code, do this ONCE for one language):

    $ python3 setup.py init_catalog -l es
    $ python3 setup.py init_catalog_js -l es


Code syntax highlight in the articles
-------------------------------------

Pyrone uses Markdown extension `codehilite` and to work properly it requires corresponding
css, currently it's commited as part of each style (in the file `blog.css`), and this css code
is generated by the following python code:

    from pygments.formatters import HtmlFormatter
    print(HtmlFormatter().get_style_defs('.codehilite'))


Release and packaging
---------------------

You MUST use activated environment for commands below! So first execute:

    $ source .venv/bin/activate

Prepare and upload source package to pypi:

    $ python3 setup.py clean compile_catalog compile_catalog_js sdist upload

Alternatively you could use the following command, it will ask you for password:

    $ python3 setup.py clean sdist upload

If you want to create source distribution package only (file `pyrone-1.4.4.tar.gz`), use 
the following command:

    $ python3 setup.py clean compile_catalog compile_catalog_js sdist


Some additional notes
=====================

Do not use sqlite even for development! Use postgresql only.

Use this command to connect postgres database:

    $ psql -h localhost pyrone_blog pyrone_blog_user

The simplest way to clear database:

    # sudo -u postgres dropdb pyrone_blog
    # sudo -u postgres createdb pyrone_blog